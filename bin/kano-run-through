#!/bin/sh

# kano-run-through
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# A script for going through the initial boot flow
#

LAUNCH_WIFI_CONFIG=1
LAUNCH_UPDATER=2
LAUNCH_SETTINGS=3
LAUNCH_PROFILE=5
LAUNCH_SWAG=6
LAUNCH_KEYBOARD=7

# Check for Kano keyboard
python -c "import kano.utils as u; import sys; sys.exit(int(u.detect_kano_keyboard()))"
if [ $? -eq 1 ];  then
    kano-tutorial
else
    # No keyboard detected
    ./kano-init-flow $LAUNCH_KEYBOARD
fi

# Launch init flow from the beginning
./kano-init-flow 0
EXIT_CODE=$?

while [ $EXIT_CODE -le $LAUNCH_UPDATER ]; do

    if [ $EXIT_CODE -eq $LAUNCH_WIFI_CONFIG ]; then
        rxvt -title \'WiFi\' -e sudo /usr/bin/kano-wifi
        # Check for internet
        /usr/bin/is_internet
        rc=$?
        if [ "$rc" -eq "0" ]; then
            ./kano-init-flow $LAUNCH_UPDATER
            EXIT_CODE=$?
        else
            # Launch again internet screen
            ./kano-init-flow 1
            EXIT_CODE=$?
        fi
    fi

    if [ $EXIT_CODE -eq $LAUNCH_UPDATER ]; then
       sudo kano-updater # ADD -f flag
       ./kano-init-flow $LAUNCH_SETTINGS
       EXIT_CODE=$?
    fi

    # If you close window, stops application crashing
    if [ $EXIT_CODE -eq 0 ]; then
       exit $?
    fi

done

if [ $EXIT_CODE -eq $LAUNCH_WIFI_CONFIG ]; then
    sudo reboot
elif [ $EXIT_CODE -eq $LAUNCH_PROFILE ]; then
    kano-login first_boot
fi

./kano-init-flow $LAUNCH_SWAG
